//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NHibernate.Cache;
using NHibernate.Cfg;
using NHibernate.Impl;
using NHibernate.Test.SecondLevelCacheTests;
using NSubstitute;
using NUnit.Framework;
using Environment = System.Environment;

namespace NHibernate.Test.SecondLevelCacheTest
{
	using System.Threading;
	[TestFixture]
	public class InvalidationTestsAsync : TestCase
	{
		protected override string MappingsAssembly => "NHibernate.Test";

		protected override IList Mappings => new[] { "SecondLevelCacheTest.Item.hbm.xml" };

		protected override void Configure(Configuration configuration)
		{
			base.Configure(configuration);
			configuration.Properties[Cfg.Environment.CacheProvider] = typeof(HashtableCacheProvider).AssemblyQualifiedName;
			configuration.Properties[Cfg.Environment.UseQueryCache] = "true";
		}

		[Test]
		public async Task InvalidatesEntitiesAsync()
		{
			var cache = Substitute.For<UpdateTimestampsCache>(Sfi.Settings, new Dictionary<string, string>());
			((SessionFactoryImpl) (Sfi as DebugSessionFactory).ActualFactory).SetPropertyUsingReflection(x => x.UpdateTimestampsCache, cache);

			var items = new List<Item>();
			using (ISession session = OpenSession())
			{
				using (ITransaction tx = session.BeginTransaction())
				{
					foreach (var i in Enumerable.Range(1, 10))
					{
						var item = new Item { Id = i };
						await (session.SaveAsync(item));
					}
					await (tx.CommitAsync());
				}

				using (ITransaction tx = session.BeginTransaction())
				{
					foreach (var i in Enumerable.Range(1, 10))
					{
						var item = await (session.GetAsync<Item>(i));
						item.Name = item.Id.ToString();
					}
					await (tx.CommitAsync());
				}

				using (ITransaction tx = session.BeginTransaction())
				{
					foreach (var i in Enumerable.Range(1, 10))
					{
						var item = await (session.GetAsync<Item>(i));
						await (session.DeleteAsync(item));
					}
					await (tx.CommitAsync());
				}
			}
			//Should receive one preinvalidation and one invalidation per commit
			await (cache.Received(3).PreInvalidateAsync(Arg.Is<object[]>(x => x.Length==1 && (string)x[0] == "Item"), CancellationToken.None));
			await (cache.Received(3).InvalidateAsync(Arg.Is<object[]>(x => x.Length == 1 && (string) x[0] == "Item"), CancellationToken.None));

		}

		public async Task CleanUpAsync(CancellationToken cancellationToken = default(CancellationToken))
		{
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				await (s.DeleteAsync("from Item", cancellationToken));
				await (tx.CommitAsync(cancellationToken));
			}
		}

		public void CleanUp()
		{
			using (ISession s = OpenSession())
			using (ITransaction tx = s.BeginTransaction())
			{
				s.Delete("from Item");
				tx.Commit();
			}
		}

		protected override void OnTearDown()
		{
			CleanUp();
			base.OnTearDown();
		}
	}
}
